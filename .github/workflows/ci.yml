name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # ğŸ§ª Quality Gate - Tests & Type Checking
  quality:
    name: ğŸ§ª Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: TypeScript check
        run: pnpm check

      - name: Server tests
        run: pnpm test

      - name: Client tests
        run: pnpm test:client

  # ğŸ›¡ï¸ Security Gate - Vulnerability Scanning
  security:
    name: ğŸ›¡ï¸ Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Audit dependencies
        run: pnpm audit --audit-level=high
        continue-on-error: true # Don't block on moderate issues

  # ğŸ—ï¸ Build Gate - Verify Build Integrity
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: pnpm build

  # ğŸš€ Deploy - Only after all gates pass
  deploy:
    name: ğŸš€ Deploy
    needs: [quality, security, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Render Deploy
        if: ${{ secrets.RENDER_DEPLOY_HOOK_URL != '' }}
        run: curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}

      - name: Deploy Status
        run: |
          if [ -z "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
            echo "âš ï¸ RENDER_DEPLOY_HOOK_URL not configured - Render auto-deploys on push"
          else
            echo "âœ… Deploy webhook triggered"
          fi
